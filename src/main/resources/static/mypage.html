네, 알겠습니다. 이전 요청에서 수정된 녹색 막대 그래프 스타일을 포함하여, 현재까지의 모든 변경사항이 적용된 전체 코드를 생략 없이 제공해 드리겠습니다.

아래 코드를 전체 복사하여 mypage.html 파일에 붙여넣으시면 모든 기능이 정상적으로 작동합니다.

code
Html
download
content_copy
expand_less

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블로그 마이페이지 - 동물의 숲 테마</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Gaegu', 'Noto Sans KR', Arial, sans-serif;
        }

        body {
            color: #5a3e2b;
            background-image: url('/images/background.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .mypage {
            display: flex;
            gap: 20px;
        }

        /* 좌측 사이드바 */
        .sidebar {
            width: 30%;
            background-color: #fff9c4;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 25px;
            border: 4px solid #a5d6a7;
            position: relative;
        }

        .sidebar:before {
            content: "";
            position: absolute;
            top: -10px;
            left: 30px;
            width: 50px;
            height: 30px;
            background-color: #81c784;
            border-radius: 50%;
            z-index: -1;
        }

        .sidebar:after {
            content: "";
            position: absolute;
            bottom: -15px;
            right: 40px;
            width: 40px;
            height: 40px;
            background-color: #ffcc80;
            border-radius: 50%;
            z-index: -1;
        }

        .profile {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .profile-img-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
        }

        .profile-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #ffb74d;
            background-color: #fff9c4;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-img-container:after {
            content: "";
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffcc80;
            border-radius: 50%;
            bottom: -5px;
            right: 0;
            border: 3px solid #ffb74d;
        }

        .profile h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #5a3e2b;
        }

        .profile p {
            color: #6d4c41;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .edit-profile-btn {
            background-color: #ffb74d;
            color: #5a3e2b;
            border: 3px solid #fb8c00;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #e65100;
        }

        .edit-profile-btn:hover {
            background-color: #ffa726;
            transform: translateY(-2px);
        }

        .edit-profile-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e65100;
        }

        .stats-section {
            margin-bottom: 30px;
            background-color: #f1f8e9;
            padding: 15px;
            border-radius: 15px;
            border: 3px dashed #c5e1a5;
        }

        .stats-section h3 {
            margin-bottom: 15px;
            color: #33691e;
            font-size: 1.3rem;
            text-align: center;
            position: relative;
            padding-bottom: 8px;
        }

        .stats-section h3:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background-color: #aed581;
            border-radius: 3px;
        }

        .chart-container {
            height: 200px;
            margin-top: 15px;
            position: relative;
        }

        /* 메인 콘텐츠 */
        .main-content {
            width: 70%;
            background-color: #e1f5fe;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 25px;
            border: 4px solid #81d4fa;
            position: relative;
        }

        .main-content:before {
            content: "";
            position: absolute;
            top: -15px;
            right: 50px;
            width: 40px;
            height: 40px;
            background-color: #4fc3f7;
            border-radius: 50%;
            z-index: -1;
        }

        .main-content:after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 70px;
            width: 30px;
            height: 30px;
            background-color: #b3e5fc;
            border-radius: 50%;
            z-index: -1;
        }

        .content-section {
            margin-bottom: 30px;
            position: relative;
        }

        .content-section > h3 {
            color: #0277bd;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            display: inline-block;
        }

        .content-section > h3:after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #4fc3f7;
            border-radius: 3px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-header h3 {
            margin-bottom: 0;
            text-align: left;
            display: block;
            position: relative;
            color: #0277bd;
            font-size: 1.5rem;
        }

        .content-header h3:after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #4fc3f7;
            border-radius: 3px;
        }

        .goal-setting-btn {
            background-color: #81d4fa;
            color: #01579b;
            border: 3px solid #4fc3f7;
            padding: 8px 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #0277bd;
            flex-shrink: 0;
        }

        .goal-setting-btn:hover {
            background-color: #4fc3f7;
            transform: translateY(-2px);
        }

        .goal-setting-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0277bd;
        }

        .progress-container {
            margin: 20px 0;
            background-color: #fff;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #b3e5fc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #01579b;
        }

        .progress-bar {
            height: 25px;
            background-color: #e3f2fd;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid #90caf9;
        }

        .progress {
            height: 100%;
            background: linear-gradient(45deg, #82b1ff, #448aff);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            transition: width 0.5s ease-in-out;
        }

        .progress:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: moveStripes 3s linear infinite;
        }

        @keyframes moveStripes {
            from {
                background-position: 0 0;
            }
            to {
                background-position: 20px 0;
            }
        }

        .fortune {
            background-color: #fffde7;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 3px solid #fff176;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .fortune:before {
            content: "✨";
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 24px;
        }

        .fortune:after {
            content: "✨";
            position: absolute;
            bottom: -15px;
            right: 20px;
            font-size: 24px;
        }

        .fortune p {
            color: #5d4037;
            line-height: 1.8;
            font-size: 1.2rem;
        }

        .fortune p strong {
            color: #f57f17;
        }

        /* ========== 목표 설정 모달 스타일 시작 ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(90, 62, 43, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background-color: #fffde7;
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #fff176;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            animation: modal-pop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        @keyframes modal-pop {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #5a3e2b;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        .goal-picker-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 30px;
        }

        .goal-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .goal-picker label {
            font-size: 1.2rem;
            color: #6d4c41;
            font-weight: bold;
        }

        .goal-picker select {
            font-family: 'Gaegu', sans-serif;
            font-size: 1.1rem;
            padding: 10px;
            border-radius: 15px;
            border: 3px solid #a5d6a7;
            background-color: #f1f8e9;
            color: #33691e;
            cursor: pointer;
            width: 120px;
            text-align: center;
        }

        .goal-picker select:focus {
            outline: none;
            border-color: #81c784;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
        }

        .cancel-btn {
            background-color: #ffcdd2;
            color: #c62828;
            border: 3px solid #ef9a9a;
            box-shadow: 0 4px 0 #b71c1c;
        }
        .cancel-btn:hover {
            background-color: #ef9a9a;
            transform: translateY(-2px);
        }
        .cancel-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #b71c1c;
        }

        .save-btn {
            background-color: #c8e6c9;
            color: #2e7d32;
            border: 3px solid #a5d6a7;
            box-shadow: 0 4px 0 #1b5e20;
        }
        .save-btn:hover {
            background-color: #a5d6a7;
            transform: translateY(-2px);
        }
        .save-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1b5e20;
        }
        /* ========== 목표 설정 모달 스타일 끝 ========== */

        /* ========== 사용자 순위 막대 그래프 스타일 (녹색 테마) ========== */
        .rank-chart-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .rank-info {
            width: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #33691e; /* 텍스트 색상: 진한 녹색 */
        }

        .rank-medal {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .rank-username {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rank-bar-wrapper {
            flex-grow: 1;
            background-color: #f1f8e9; /* 배경색: 연한 녹색 */
            border-radius: 20px;
            padding: 5px;
            border: 2px solid #a5d6a7; /* 테두리 색상: 녹색 */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .rank-bar {
            height: 30px;
            background: linear-gradient(90deg, #a5d6a7, #81c784); /* 막대 색상: 녹색 그라데이션 */
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: #1b5e20; /* 막대 안 텍스트 색상: 매우 진한 녹색 */
            font-weight: bold;
            font-size: 1rem;
            padding-right: 10px;
            transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
            overflow: hidden;
        }

        .rank-bar:after { /* 줄무늬 효과 */
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            opacity: 0.5;
        }

        .rank-count {
            z-index: 1;
        }
        /* ========== 사용자 순위 막대 그래프 스타일 끝 ========== */

        /* 동물의 숲 스타일 데코레이션 요소 */
        .leaf-decoration {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #a5d6a7;
            border-radius: 50% 0 50% 0;
            transform: rotate(45deg);
        }

        .leaf-1 { top: 20px; right: 20px; }
        .leaf-2 { bottom: 30px; left: 20px; }
        .leaf-3 { top: 50%; right: 30px; }

        .fish-decoration {
            position: absolute;
            width: 30px;
            height: 15px;
            background-color: #90caf9;
            border-radius: 50%;
            transform: rotate(30deg);
        }

        .fish-1 { bottom: 40px; right: 40px; }
        .fish-2 { top: 30px; left: 50px; }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .mypage {
                flex-direction: column;
            }
            .sidebar, .main-content {
                width: 100%;
            }
            .rank-info {
                width: 100px;
                font-size: 1.1rem;
            }
        }

        /* 꾸미기 요소들 */
        .page-title {
            text-align: center;
            font-size: 2.5rem;
            color: #5a3e2b;
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%);
        }

        .page-title:before, .page-title:after {
            content: "🍃";
            margin: 0 10px;
        }

        /* 로딩 상태 표시 */
        .loading {
            text-align: center;
            color: #0277bd;
            font-size: 1.2rem;
            padding: 20px;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #ef5350;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="page-title">내 숲의 일지</h1>
    <div class="mypage">
        <!-- 좌측 사이드바 -->
        <div class="sidebar">
            <div class="leaf-decoration leaf-1"></div>
            <div class="leaf-decoration leaf-2"></div>
            <div class="profile">
                <div class="profile-img-container">
                    <img id="profile-image" class="profile-img" src="/images/default-profile.png" alt="프로필 이미지">
                </div>
                <h2 id="nickname-area">🌿 숲지기님 🌿</h2>
                <p id="join-date">🏝️ 입도일: 2023년 10월 1일</p>
                <button class="edit-profile-btn">프로필 꾸미기</button>
                <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
            </div>
            <div class="stats-section">
                <h3>🔍 최근 7일간 방문객 수</h3>
                <div class="chart-container">
                    <canvas id="views-chart"></canvas>
                </div>
            </div>
            <div class="stats-section">
                <h3>✏️ 최근 7일간 글 작성수</h3>
                <div class="chart-container">
                    <canvas id="posts-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <div class="fish-decoration fish-1"></div>
            <div class="fish-decoration fish-2"></div>
            <div class="content-section">
                <div class="content-header">
                    <h3>🎯 글 작성 목표</h3>
                    <button class="goal-setting-btn">목표설정</button>
                </div>
                <div class="progress-container" id="monthly-progress">
                    <div class="progress-info">
                        <span>이번 달 목표: 30개</span>
                        <span>12/30 (40%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="progress-container" id="weekly-progress">
                    <div class="progress-info">
                        <span>이번 주 목표: 7개</span>
                        <span>3/7 (43%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="content-section">
                <h3>🔮 오늘의 운세</h3>
                <div class="fortune">
                    <p id="today-fortune-date"><strong>2025년 3월 29일의 숲 운세</strong></p>
                    <p>오늘은 행운의 별이 빛나는 날입니다! 🌟 창의적인 아이디어가 새싹처럼 솟아날 거예요. 블로그에 새로운 주제로 글을 쓰면 많은 방문객들이 찾아올 거에요. 특히 오후에는 집중력이 높아져 글쓰기에 좋은 시간이 될 거예요. 오늘의 행운 아이템은 '푸른 꽃' 입니다!</p>
                </div>
            </div>
            <div class="content-section">
                <h3>🏆 숲의 활동가 순위</h3>
                <div id="user-rank-chart" class="rank-chart-container">
                    <!-- JavaScript가 이 영역을 순위 그래프로 채웁니다. -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 목표 설정 모달 -->
<div class="modal-overlay" id="goal-modal">
    <div class="modal-content">
        <h2>🎯 목표 설정</h2>
        <div class="goal-picker-container">
            <div class="goal-picker">
                <label for="monthly-goal-select">이번 달 목표</label>
                <select id="monthly-goal-select"></select>
            </div>
            <div class="goal-picker">
                <label for="weekly-goal-select">이번 주 목표</label>
                <select id="weekly-goal-select"></select>
            </div>
        </div>
        <div class="modal-buttons">
            <button id="save-goal-btn" class="modal-btn save-btn">저장</button>
            <button id="cancel-goal-btn" class="modal-btn cancel-btn">취소</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script>
    // ========== 전역 변수 및 상태 관리 ==========
    let userProgress = {
        monthly: { current: 12, goal: 30 },
        weekly: { current: 3, goal: 7 }
    };

    let chartInstances = {};
    let isServerAvailable = false;

    // ========== 통합된 앱 초기화 ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🌟 마이페이지 초기화 시작...');
        initializeBasicSettings();
        loadUserProfile();
        setupEventListeners();
        initializeGoalModal();
        createDefaultCharts();
        updateGoalProgressUI();
        updateFortuneDate();
        loadUserRanks();
        setTimeout(() => {
            fetchUserStats();
        }, 100);
    });

    // ========== 기본 설정 ==========
    function initializeBasicSettings() {
        console.log('📝 기본 설정 초기화...');
        const nickname = localStorage.getItem("nickname") || "숲지기";
        document.getElementById("nickname-area").innerText = `🌿 ${nickname}님 🌿`;
        console.log(`✅ 닉네임 설정 완료: ${nickname}`);
    }

    // ========== 사용자 프로필 정보 로드 ==========
    async function loadUserProfile() {
        console.log('👤 사용자 프로필 정보 로드...');
        const username = localStorage.getItem("username");
        if (!username) {
            console.log('❌ 사용자명이 없음');
            return;
        }
        try {
            const response = await fetch(`/api/users/profile?username=${username}`);
            if (!response.ok) throw new Error(`프로필 정보 가져오기 실패: ${response.status}`);
            const data = await response.json();
            const profileImg = document.getElementById('profile-image');
            if (profileImg && data.profileImagePath) profileImg.src = data.profileImagePath;
            const joinDateElem = document.getElementById('join-date');
            if (joinDateElem && data.joinDate) joinDateElem.innerText = `🏝️ 입도일: ${formatDate(data.joinDate)}`;
        } catch (error) {
            console.error('❌ 프로필 정보 로드 실패:', error);
        }
    }

    // ========== 사용자 순위 정보 로드 및 그래프 생성 ==========
    async function loadUserRanks() {
        console.log('🏆 사용자 순위 정보 로드 시작...');
        const container = document.getElementById('user-rank-chart');
        if (!container) return;

        container.innerHTML = `<div class="loading">순위를 불러오는 중... 🏆</div>`;

        try {
            const response = await fetch('http://localhost:8080/api/board/ranks');
            if (!response.ok) throw new Error(`API 호출 실패: ${response.status}`);
            const ranks = await response.json();
            console.log('✅ 사용자 순위 정보 수신:', ranks);

            container.innerHTML = '';

            if (!ranks || ranks.length === 0) {
                container.innerHTML = '<p class="loading">아직 순위 데이터가 없어요. ✏️</p>';
                return;
            }

            const maxCount = Math.max(...ranks.map(r => r.postCount), 1);

            ranks.forEach((user, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'rank-item';
                rankItem.style.animationDelay = `${index * 100}ms`;
                const barWidth = (user.postCount / maxCount) * 100;
                rankItem.innerHTML = `
                    <div class="rank-info">
                        <span class="rank-medal">${getMedalEmoji(user.rank)}</span>
                        <span class="rank-username">${user.username}</span>
                    </div>
                    <div class="rank-bar-wrapper">
                        <div class="rank-bar" style="width: 0%;" data-target-width="${barWidth}%">
                            <span class="rank-count">${user.postCount}개</span>
                        </div>
                    </div>
                `;
                container.appendChild(rankItem);
            });

            setTimeout(() => {
                document.querySelectorAll('.rank-bar').forEach(bar => {
                    bar.style.width = bar.dataset.targetWidth;
                });
            }, 100);

        } catch (error) {
            console.error('❌ 사용자 순위 로드 실패:', error);
            container.innerHTML = `<div class="error-message">순위를 불러오는 데 실패했어요. 😭</div>`;
        }
    }

    function getMedalEmoji(rank) {
        if (rank === 1) return '🥇';
        if (rank === 2) return '🥈';
        if (rank === 3) return '🥉';
        return `<strong>${rank}</strong>`;
    }

    // ========== 날짜 및 운세 업데이트 ==========
    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getFullYear()}년 ${(date.getMonth() + 1).toString().padStart(2, '0')}월 ${date.getDate().toString().padStart(2, '0')}일`;
    }

    function updateFortuneDate() {
        const today = new Date();
        const fortuneDateElement = document.getElementById('today-fortune-date');
        if (fortuneDateElement) {
            fortuneDateElement.innerHTML = `<strong>${today.getFullYear()}년 ${today.getMonth() + 1}월 ${today.getDate()}일의 숲 운세</strong>`;
        }
    }

    // ========== 이벤트 리스너 설정 ==========
    function setupEventListeners() {
        console.log('🔗 이벤트 리스너 설정...');
        const editProfileBtn = document.querySelector('.edit-profile-btn');
        const profileImageInput = document.getElementById('profileImageInput');
        if (editProfileBtn && profileImageInput) {
            editProfileBtn.addEventListener('click', () => profileImageInput.click());
            profileImageInput.addEventListener('change', handleProfileImageUpload);
        }
        const goalSettingBtn = document.querySelector('.goal-setting-btn');
        if (goalSettingBtn) goalSettingBtn.addEventListener('click', openGoalModal);
        const cancelGoalBtn = document.getElementById('cancel-goal-btn');
        if (cancelGoalBtn) cancelGoalBtn.addEventListener('click', closeGoalModal);
        const saveGoalBtn = document.getElementById('save-goal-btn');
        if (saveGoalBtn) saveGoalBtn.addEventListener('click', saveGoalsToServer);
        const goalModal = document.getElementById('goal-modal');
        if (goalModal) goalModal.addEventListener('click', (event) => {
            if (event.target === goalModal) closeGoalModal();
        });
    }

    // ========== 프로필 이미지 업로드 ==========
    async function handleProfileImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("image", file);
        const username = localStorage.getItem("username");
        if (username) formData.append("username", username);
        try {
            const response = await fetch('/api/profile/upload', { method: 'POST', body: formData });
            if (response.ok) {
                document.getElementById('profile-image').src = await response.text();
                alert("🌿 프로필 이미지가 변경되었어요!");
            } else {
                alert("😅 업로드 실패(로그아웃 상태 또는 파일 크기 제한)");
            }
        } catch (error) {
            console.error('❌ 프로필 이미지 업로드 오류:', error);
            alert("📡 오류 발생(로그아웃 상태 또는 파일 크기 제한)");
        }
    }

    // ========== 목표 설정 모달 ==========
    function initializeGoalModal() {
        const monthlySelect = document.getElementById('monthly-goal-select');
        const weeklySelect = document.getElementById('weekly-goal-select');
        if (!monthlySelect || !weeklySelect) return;
        for (let i = 1; i <= 100; i++) monthlySelect.add(new Option(`${i}개`, i));
        for (let i = 1; i <= 20; i++) weeklySelect.add(new Option(`${i}개`, i));
    }

    function openGoalModal() {
        const monthlySelect = document.getElementById('monthly-goal-select');
        const weeklySelect = document.getElementById('weekly-goal-select');
        const goalModal = document.getElementById('goal-modal');
        if (monthlySelect && weeklySelect && goalModal) {
            monthlySelect.value = userProgress.monthly.goal;
            weeklySelect.value = userProgress.weekly.goal;
            goalModal.classList.add('show');
        }
    }

    function closeGoalModal() {
        document.getElementById('goal-modal').classList.remove('show');
    }

    async function saveGoalsToServer() {
        const newMonthlyGoal = parseInt(document.getElementById('monthly-goal-select').value);
        const newWeeklyGoal = parseInt(document.getElementById('weekly-goal-select').value);
        const username = localStorage.getItem('username') || 'user';
        const goalData = { monthlyGoal: newMonthlyGoal, weeklyGoal: newWeeklyGoal };
        try {
            const response = await fetch('/api/user/stats/goals', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Username': username },
                body: JSON.stringify(goalData)
            });
            if (!response.ok) throw new Error(`서버 오류: ${response.status}`);
            alert('🎯 목표가 성공적으로 저장되었습니다!');
        } catch (error) {
            alert('📡 서버 연결에 문제가 있지만, 임시로 목표를 설정했습니다.');
        } finally {
            userProgress.monthly.goal = newMonthlyGoal;
            userProgress.weekly.goal = newWeeklyGoal;
            updateGoalProgressUI();
            closeGoalModal();
        }
    }

    // ========== 서버 데이터 로드 (통계) ==========
    async function fetchUserStats() {
        const username = localStorage.getItem('username') || 'user';
        try {
            const response = await fetch('/api/user/stats', { headers: { 'Username': username } });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            isServerAvailable = true;
            if (data.goalProgress) {
                userProgress.monthly.current = data.goalProgress.monthlyPosts || 0;
                userProgress.monthly.goal = data.goalProgress.monthlyGoal || 30;
                userProgress.weekly.current = data.goalProgress.weeklyPosts || 0;
                userProgress.weekly.goal = data.goalProgress.weeklyGoal || 7;
            }
            if (data.viewStats && data.viewStats.length > 0) updateViewsChart(data.viewStats);
            if (data.postStats && data.postStats.length > 0) updatePostsChart(data.postStats);
            updateGoalProgressUI();
        } catch (error) {
            console.error('❌ 사용자 통계 데이터 가져오기 실패:', error);
            isServerAvailable = false;
        }
    }

    // ========== 차트 생성 및 업데이트 ==========
    function createChart(canvasId, statsData, colors, borderColor) {
        if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const labels = statsData.map(item => item.date);
        const data = statsData.map(item => item.views || item.posts);
        chartInstances[canvasId] = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ data, backgroundColor: colors, borderColor, borderWidth: 2, borderRadius: 8 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { font: { family: 'Gaegu', size: 14 } } },
                    x: { ticks: { font: { family: 'Gaegu', size: 14 } } }
                }
            }
        });
    }

    function updateViewsChart(viewStats) {
        createChart('views-chart', viewStats, ['#81c784', '#66bb6a', '#4caf50', '#43a047', '#388e3c', '#2e7d32', '#1b5e20'], '#1b5e20');
    }

    function updatePostsChart(postStats) {
        createChart('posts-chart', postStats, ['#ffcc80', '#ffb74d', '#ffa726', '#ff9800', '#fb8c00', '#f57c00', '#ef6c00'], '#e65100');
    }

    function createDefaultCharts() {
        const defaultViews = Array.from({length: 7}, (_, i) => ({date: `${6-i}일전`, views: 15 + i*2 + Math.floor(Math.random()*5)}));
        const defaultPosts = Array.from({length: 7}, (_, i) => ({date: `${6-i}일전`, posts: Math.floor(Math.random()*3)}));
        updateViewsChart(defaultViews);
        updatePostsChart(defaultPosts);
    }

    // ========== 목표 진행률 UI 업데이트 ==========
    function updateGoalProgressUI() {
        const update = (id, data, type) => {
            const container = document.getElementById(id);
            if (!container) return;
            const percent = data.goal > 0 ? Math.min(Math.round((data.current / data.goal) * 100), 100) : 0;
            container.querySelector('.progress-info').innerHTML = `<span>${type} 목표: ${data.goal}개</span><span>${data.current}/${data.goal} (${percent}%)</span>`;
            container.querySelector('.progress').style.width = `${percent}%`;
        };
        update('monthly-progress', userProgress.monthly, '이번 달');
        update('weekly-progress', userProgress.weekly, '이번 주');
    }
</script>
</body>
</html>